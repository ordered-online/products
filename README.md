# ordered online products service

This django based micro service provides an API to obtain products from locations.

## Technology Stack

- Python 3
- Django

## Quickstart

```
$ python3 -m pip install -r requirements.txt
```

Run the server in development mode.

```
$ cd codes
$ python3 manage.py migrate
$ python3 manage.py runserver 127.0.0.1:8002
```

Note that verification based endpoints need the `locations` and the `verification` service to run.

## API Endpoints

Following API Endpoints are supported:

### Create a product with `/products/create/`

Create a product.
Method: POST

This endpoint is secured by verification.
The default location for the verification service to run is at http://127.0.0.1:8000/.
The default location for the locations service to run is at http://127.0.0.1:8001/.
You need to pass the verification session key and the verification user_id.
If you create a product for a location, it is verified that you are the location owner first.

| Parameter   | Explanation                                         |
| ----------- | --------------------------------------------------- |
| user_id     | User id for user verification.                      |
| session_key | Session key for user verification.                  |
| product     | The product to be created, without an id attribute. |

Example product creation with `curl`:

```
curl -i -X POST -H 'Content-Type: application/json' -d '{
    "session_key": "wf9xncryitkaxvkna7x9cq25wcs8ue79",
    "user_id": 1,
    "product": {
        "location_id":1,
        "name":"Coffee",
        "description":"The elexir of computer scientists. 1 Euro deposit included for the cup.",
        "price":"1.80",
        "categories":[
            {
                "name":"Drink"
            }
        ],
        "tags":[
            {
                "name":"stimulating"
            }
        ],
        "additives": [
            {
                "name":"caffeine"
            }
        ]
    }
}' http://127.0.0.1:8002/products/create/
```

Of course, it is required, that the user 1 exists in the verification service and the session key is still valid.
Note, that the `id` field is not passed, since it is autogenerated by django.

Example response:

```
{
   "id": 1,
   "location_id":1,
   "name":"Coffee",
   "description":"The elexir of computer scientists. 1 Euro deposit included for the cup.",
   "price":"1.80",
   "categories":[
      {
            "name":"Drink"
      }
   ],
   "tags":[
      {
            "name":"stimulating"
      }
   ],
   "additives": [
      {
            "name":"caffeine"
      }
   ]
}
```

Failure Responses:

- [IncorrectAccessMethod](#IncorrectAccessMethod) if the service was accessed with any other method than specified.
- [IncorrectCredentials](#IncorrectCredentials) if the passed credentials were incorrect.
- [DuplicateProduct](#DuplicateProduct) if the given product exists by means of all unique constraints.
- [MalformedJson](#MalformedJson) if the given Json was malformed.
- [VerificationServiceUnavailable](#VerificationServiceUnavailable) if the verification service could not be contacted.
- [LocationsServiceUnavailable](#LocationsServiceUnavailable) if the locations service could not be contacted.

### Edit a product with `/products/edit/<product_id>/`

Edit a product.
Method: POST

This endpoint is secured by verification.
The default location for the verification service to run is at http://127.0.0.1:8000/.
The default location for the locations service to run is at http://127.0.0.1:8001/.
You need to pass the verification session key and the verification user_id.
If you create a product for a location, it is verified that you are the location owner first.

| Parameter   | Explanation                                         |
| ----------- | --------------------------------------------------- |
| user_id     | User id for user verification.                      |
| session_key | Session key for user verification.                  |
| product     | The product to be created, without an id attribute. |

Example of editing a product with `curl`:

```
curl -i -X POST -H 'Content-Type: application/json' -d '{
    "session_key": "wf9xncryitkaxvkna7x9cq25wcs8ue79",
    "user_id": 1,
    "product": {
        "location_id":1,
        "name":"Coffee (Edited)",
        "description":"The elexir of computer scientists. 1 Euro deposit included for the cup.",
        "price":"1.80",
        "categories":[
            {
                "name":"Drink"
            }
        ],
        "tags":[
            {
                "name":"stimulating"
            }
        ],
        "additives": [
            {
                "name":"caffeine"
            }
        ]
    }
}' http://127.0.0.1:8002/products/edit/1/
```

Of course, it is required, that the user 1 exists in the verification service and the session key is still valid.
The location has to exist as well.
Note, that the `id` field **must not** be passed in json, since it is inferred by the url.

Example response:

```
{
   "id": 1,
   "location_id":1,
   "name":"Coffee (Edited)",
   "description":"The elexir of computer scientists. 1 Euro deposit included for the cup.",
   "price":"1.80",
   "categories":[
      {
            "name":"Drink"
      }
   ],
   "tags":[
      {
            "name":"stimulating"
      }
   ],
   "additives": [
      {
            "name":"caffeine"
      }
   ]
}
```

Failure Responses:

- [ProductNotFound](#ProductNotFound) if the product under the given id could not be found.
- [IncorrectCredentials](#IncorrectCredentials) if the passed credentials were incorrect.
- [IncorrectAccessMethod](#IncorrectAccessMethod) if the service was accessed with any other method than specified.
- [MalformedJson](#MalformedJson) if the given Json was malformed.
- [VerificationServiceUnavailable](#VerificationServiceUnavailable) if the verification service could not be contacted.
- [LocationsServiceUnavailable](#LocationsServiceUnavailable) if the locations service could not be contacted.

### Find a product with`/products/find/`

Finds a product to the given parameters.
Method: GET

| Parameter   | Explanation                                                                  |
| ----------- | ---------------------------------------------------------------------------- |
| location_id | Search for products by a specific location id.                               |
| name        | Search for products, whose names contain the given query (case insensitive). |
| category    | Search for products with a given category.                                   |
| tag         | Search for products with a given tag.                                        |
| additive    | Search for products with a given additive.                                   |

At least one of these parameters should be supplied. All parameters can be combined.
Results are limited to 1000 products.

Example name search with `curl`:

```
$ curl -i -X GET http://127.0.0.1:8002/products/find/?name=coffee

{
   [
      {
         "id":1,
         "location_id":1,
         "name":"Coffee",
         "description":"The elexir of computer scientists. 1 Euro deposit included for the cup.",
         "price":"1.80",
         "categories":[
            {
               "name":"Drink"
            }
         ],
         "tags":[
            {
               "name":"stimulating"
            }
         ],
         "additives":[
            {
               "name":"caffeine"
            }
         ]
      }
   ]
}
```

Example search for a given tag and a given category with `curl`:

```
$ curl -i -X GET http://127.0.0.1:8002/products/find/?tag=stimulating&category=caffeine

{
   [
      {
         "id":1,
         "location_id":1,
         "name":"Coffee",
         "description":"The elexir of computer scientists. 1 Euro deposit included for the cup.",
         "price":"1.80",
         "categories":[
            {
               "name":"Drink"
            }
         ],
         "tags":[
            {
               "name":"stimulating"
            }
         ],
         "additives":[
            {
               "name":"caffeine"
            }
         ]
      }
   ]
}
```

Failure Responses:

- [IncorrectAccessMethod](#IncorrectAccessMethod) if the service was accessed with any other method than specified.
- [MalformedJson](#MalformedJson) if the passed json does not conform to the given description.

### `/products/get/<product_id>/`

Gets the requested product.
Methods: GET.

Example with `curl`:

```
$ curl -i -X GET http://127.0.0.1:8002/products/get/1/

{
   "id":1,
   "location_id":1,
   "name":"Coffee",
   "description":"The elexir of computer scientists. 1 Euro deposit included for the cup.",
   "price":"1.80",
   "categories":[
      {
         "name":"Drink"
      }
   ],
   "tags":[
      {
         "name":"stimulating"
      }
   ],
   "additives":[
      {
         "name":"caffeine"
      }
   ]
}
```

Failure Responses:

- [IncorrectAccessMethod](#IncorrectAccessMethod) if the service was accessed with any other method than specified.
- [ProductNotFound](#ProductNotFound) if the requested product could not be found.

## Failure Responses

Following failure responses are supported:

### IncorrectCredentials

Code: 403

```
{
   "success":false,
   "reason":"incorrect_credentials"
}
```

### MalformedJson

Code: 400

```
{
    "success":false,
    "reason":"malformed_json"
}
```

### DuplicateProduct

Code: 400

```
{
    "success":false,
    "reason":"duplicate_product"
}
```

### VerificationServiceUnavailable

Code: 503

```
{
    "success":false,
    "reason":"verification_service_unavailable"
}
```

### LocationsServiceUnavailable

Code: 503

```
{
    "success":false,
    "reason":"locations_service_unavailable"
}
```

### IncorrectAccessMethod

Code: 405

```
{
   "success":false,
   "reason":"incorrect_access_method"
}
```

### ProductNotFound

Code: 404

```
{
   "success":false,
   "reason":"product_not_found"
}
```
